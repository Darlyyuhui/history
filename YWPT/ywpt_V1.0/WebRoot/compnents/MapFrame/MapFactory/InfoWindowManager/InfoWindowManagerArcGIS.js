MapFactory.Define("MapFactory/InfoWindowManager",[	"MapFactory/InfoWindowManagerAPI*",	"MapFactory/MapManager",	"MapFactory/GeometryUtil"],function(api,MapManager,geoUtil){	return function(conf){		var _mapManager = MapManager();		var _map = MapFactory._MapManagerResource[MapFactory.Engine],			_infoWindow = _map.infoWindow,			_isCenterInfowindow,			_isCenter,			_level,			_geoUtil = geoUtil(),			_anchor = null,			_title = "属性框",_content = "",			_width = "",_height = "",			_url,_option,_callback,			_conf = {				url : "",				option : "",				callback : "",				anchor : "",				title : "",				content : "",				width : "",				height : ""			};		MapFactory.Extend(_conf,conf);		_width = _conf.width ? _conf.width : _width;		_height = _conf.height ? _conf.height : _height;		_anchor = _conf.anchor;		_title = _conf.title ? _conf.title : _title;		_content = _conf.content;		_url = _conf.url;		_option = _conf.option;		_callback = _conf.callback;		function setAnchor(point){			_anchor = _geoUtil.convertFromMapFactory(point);		}		function setTitle(title){			_title = title || _title;		}		function setContent(content){			_content = content || _content;		}		function _setContent(){			_infoWindow.setContent("");			_infoWindow.setContent("<div id='mapInfoWindowContentBox'>"+_content+"</div>");		}		function setWidth(width){			_width = width || _width;		}		function setHeight(height){			_height = height || _height;		}		function _resize(){			var mapInfoWindowContentBox = document.getElementById("mapInfoWindowContentBox");			var style = getInnerStyle(mapInfoWindowContentBox);			mapInfoWindowContentBox.style.width = style.width + "px";			mapInfoWindowContentBox.style.height = style.height + "px";			_width = style.width;			_height = style.height;			_infoWindow.resize(parseInt(_width)+20,parseInt(_height)+20);		}				function _setCenterInfowindow(callback) {			if(!_isCenter && !_isCenterInfowindow)return;			if(_map.getLevel() < _level) {				_map.centerAndZoom(_anchor,_level).then(function(){					if(_isCenterInfowindow)_mapManager.centerAtWithOffset(_anchor.x,_anchor.y,_width/2,0,callback);					else if(_isCenter)_mapManager.centerAt(_anchor.x,_anchor.y,callback);				});			}			else {				if(_isCenterInfowindow)_mapManager.centerAtWithOffset(_anchor.x,_anchor.y,_width/2,0,callback);				else if(_isCenter)_mapManager.centerAt(_anchor.x,_anchor.y,callback);			}		}		function showAndCenterInfowindow(level){			_isCenter = false;			_isCenterInfowindow = true;			if(typeof level != 'undefined') {				_level = parseInt(level);			}			else {				_level = _mapManager.getLevel();			}			_level = _mapManager.getLevel();			_width=1200;			_setCenterInfowindow(function(){				show();			});		}				function showAndCenter(level){			_isCenter = true;			_isCenterInfowindow = false;			if(typeof level != 'undefined') {				_level = parseInt(level);			}			else {				_level = _mapManager.getLevel();			}			show();		}				function show(){			_infoWindow.resize(0,0);			if(_url){				_loadPage();			}else{				_infoWindow.setTitle(_title);				if(_content){					_setContent();				}				if(_width && _height){					_infoWindow.resize(_width,_height);				}else{					var style = getInnerStyle(document.getElementById("mapInfoWindowContentBox"));					_width = style.width;					_height = style.height;					_resize();				}				_infoWindow.show(_anchor);				_setCenterInfowindow();			}		}		function hide(){			_infoWindow.hide();		}		function setWaitingStatus(){			_content = "<div class='infoWindowLoading'></div><div id='infoWindowTempContent'></div>";			_setContent();		}		function setLoadPage(url,option,callback){			_url = url;			_option = option;			_callback = callback;			if(!_option){				_option = {};			}		}		function _loadPage(){			setWaitingStatus();			MapFactory.XHR.Load("infoWindowTempContent",_url,_option,function(){				var _infoTempContent = document.getElementById("infoWindowTempContent");				if(!_infoTempContent){					return;				}				_content = _infoTempContent.innerHTML;				_setContent();				_infoWindow.setTitle(_title);				setTimeout(function(){					/*var mapInfoWindowContentBox = document.getElementById("mapInfoWindowContentBox");					var style = getInnerStyle(mapInfoWindowContentBox);					mapInfoWindowContentBox.style.width = style.width + "px";					mapInfoWindowContentBox.style.height = style.height + "px";					_width = style.width;					_height = style.height;*/					_resize();					_setCenterInfowindow();				},1000);				_infoWindow.show(_anchor);				if(_callback){					_callback();				}			});		}		function getInnerStyle(elem){			var _maxWidth = 0, _maxHeight = 0,				_children = elem.childNodes,				_num = _children.length;			if(elem.offsetWidth > _maxWidth){				_maxWidth = elem.offsetWidth;			}			if(elem.offsetHeight > _maxHeight){				_maxHeight = elem.offsetHeight;			}			if(_num){				for(var i=0;i<_num;i++){					var _style = getInnerStyle(_children[i]);					if(_style.width > _maxWidth){						_maxWidth = _style.width;					}					if(_style.height > _maxHeight){						_maxHeight = _style.height;					}				}			}else{				_maxWidth = elem.scrollWidth;				_maxHeight = elem.scrollHeight;			}			return {				width : _maxWidth,				height : _maxHeight			};		}		return eval(MapFactory.GenerateAPI(api));	}});