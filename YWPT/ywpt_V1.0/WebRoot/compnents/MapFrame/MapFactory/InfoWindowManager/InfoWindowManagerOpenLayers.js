MapFactory.Define("MapFactory/InfoWindowManager",[	"MapFactory/InfoWindowManagerAPI*",	"MapFactory/MapManager",	"MapFactory/GeometryUtil"],function(api,MapManager,geoUtil){	var _infoWindow = null;	return function(conf){		var _mapManager = MapManager();		var _map = MapFactory._MapManagerResource[MapFactory.Engine],			_geoUtil = geoUtil(),			_anchor = null,			_isCenterInfowindow,			_isCenter,			_level,			_title = "信息框",_content = "",			_titleContainer = "<div id='infoWTitleContainer'><span id='infoWTitle'></span><span id='infoWClose'>×</span></div>",			_contentContainer = "<div id='infoWContentContainer'></div>",			_titleC = null,_contentC = null,_closeC = null,			_width = "",_height = "",			_url,_option,_callback,			_conf = {				url : "",				option : "",				callback : "",				anchor : "",				title : "",				content : "",				width : "",				height : ""			};		MapFactory.Extend(_conf,conf);		if(!_infoWindow){			_infoWindow = new OpenLayers.Popup("mapInfoWindow");			_infoWindow.setContentHTML(_titleContainer + _contentContainer);		}		_width = _conf.width ? _conf.width : _width;		_height = _conf.height ? _conf.height : _height;		_anchor = _conf.anchor;		_title = _conf.title ? _conf.title : _title;		_content = _conf.content;		_url = _conf.url;		_option = _conf.option;		_callback = _conf.callback;		function setAnchor(point){			_anchor = _geoUtil.convertFromMapFactory(point);		}		function setTitle(title){			_title = title || _title;		}		function setContent(content){			_content = content || _content;		}		function setWidth(width){			_width = width || _width;		}		function setHeight(height){			_height = height || _height;		}				function _resize(){			_infoWindow.setSize(new OpenLayers.Size(parseInt(_width),parseInt(_height)+25));		}				function _setCenterInfowindow() {			if(!_isCenter && !_isCenterInfowindow)return;			if(_map.getZoom() < _level){				_map.setCenter(_anchor,_level);			}			if(_isCenterInfowindow)_mapManager.centerAtWithOffset(_anchor.x,_anchor.y,_width/2,_height/2);			else if(_isCenter)_map.setCenter(_anchor);		}				function showAndCenterInfowindow(level){			_isCenter = false;			_isCenterInfowindow = true;			if(typeof level != 'undefined') {				_level = parseInt(level);			}			else {				_level = _map.getZoom();			}			show();		}				function showAndCenter(level){			_isCenter = true;			_isCenterInfowindow = false;			if(typeof level != 'undefined') {				_level = parseInt(level);			}			else {				_level = _map.getZoom();			}			_level = _map.getZoom();			show();		}		function show(){			_infoWindow.lonlat = new OpenLayers.LonLat(_anchor.x,_anchor.y);			_map.addPopup(_infoWindow);			_infoWindow.show();			_titleC = document.getElementById("infoWTitle");			_contentC = document.getElementById("infoWContentContainer");			_closeC = document.getElementById("infoWClose");			_closeC.onclick = function(){				_infoWindow.hide();			}			if(_title && _titleC){				_titleC.innerHTML = _title;			}			if(_url){				_loadPage();			}else{				if(_content && _contentC){					_contentC.innerHTML = _content;				}				if(!_width || !_height){					var style = getInnerStyle(_contentC);					_width = style.width;					_height = style.height;				}				_resize();				_setCenterInfowindow();			}		}		function hide(){			_infoWindow.hide();		}		function setLoadPage(url,option,callback){			_url = url;			_option = option;			_callback = callback;			if(!_option){				_option = {};			}		}		function _loadPage(){			_width = 230;			_height = 60;			_resize();			_contentC.innerHTML = "<div class='infoWindowLoading'></div><div id='infoWindowTempContent'></div>";			setTimeout(function(){				MapFactory.XHR.Load("infoWindowTempContent",_url,_option,function(){					var _infoTempContent = document.getElementById("infoWindowTempContent");					if(!_infoTempContent){						return;					}					_contentC.innerHTML = _infoTempContent.innerHTML;					setTimeout(function(){						var style = getInnerStyle(_contentC);						_width = style.width;						_height = style.height;						_resize();						_setCenterInfowindow();					},500);					if(_callback){						_callback();					}				});			},500);		}		function getInnerStyle(elem){			var _maxWidth = 0, _maxHeight = 0,				_children = elem.childNodes,				_num = _children.length;			if(_num){				if(elem.offsetWidth > _maxWidth){					_maxWidth = elem.offsetWidth;				}				if(elem.offsetHeight > _maxHeight){					_maxHeight = elem.offsetHeight;				}				for(var i=0;i<_num;i++){					var _style = getInnerStyle(_children[i]);					if(_style.width > _maxWidth){						_maxWidth = _style.width;					}					if(_style.height > _maxHeight){						_maxHeight = _style.height;					}				}				return {					width : _maxWidth,					height : _maxHeight				};			}else{				_maxWidth = elem.offsetWidth || 0;				_maxHeight = elem.offsetHeight || 0;			}			return {				width : _maxWidth,				height : _maxHeight			};		}		return eval(MapFactory.GenerateAPI(api));	}});